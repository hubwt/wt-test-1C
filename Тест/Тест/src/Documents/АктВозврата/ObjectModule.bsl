
Процедура ОбработкаЗаполнения(ДанныеЗаполнения, ТекстЗаполнения, СтандартнаяОбработка)
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ПродажаЗапчастей") Тогда
		
		Дата		   = ТекущаяДата();
		Склад 		   = ДанныеЗаполнения.Склад;
		Клиент 	       = ДанныеЗаполнения.Клиент;
		Продажа 	   = ДанныеЗаполнения.Ссылка;
		Ответственный  = ДанныеЗаполнения.КтоПродал;
		СлужбаДоставки = ДанныеЗаполнения.Доставка;
		Инициатор 	   = Пользователи.ТекущийПользователь();
		Организация    = ДанныеЗаполнения.Организация;
		
		Для Каждого ТекСтрокаТаблица Из ДанныеЗаполнения.Таблица Цикл
			Если ТекСтрокаТаблица.Отменено Тогда
				НоваяСтрока = Таблица.Добавить();
				НоваяСтрока.Комментарий = ТекСтрокаТаблица.Комментарий;
				НоваяСтрока.Количество  = ТекСтрокаТаблица.Количество;
				НоваяСтрока.Отменено 	= ТекСтрокаТаблица.Отменено;
				НоваяСтрока.ПродНак 	= ТекСтрокаТаблица.ПродНак;
				НоваяСтрока.машина 		= ТекСтрокаТаблица.машина;
				НоваяСтрока.Партия 		= ТекСтрокаТаблица.Партия;
				НоваяСтрока.Скидка 		= ТекСтрокаТаблица.Скидка;
				НоваяСтрока.Склад 		= ДанныеЗаполнения.Склад;
				НоваяСтрока.Сумма 		= ТекСтрокаТаблица.Сумма;
				НоваяСтрока.Товар 		= ТекСтрокаТаблица.Товар;
				НоваяСтрока.укод 		= ТекСтрокаТаблица.Товар.Код; 
				НоваяСтрока.Цена		= ТекСтрокаТаблица.Цена;	
				НоваяСтрока.Артикул     = ТекСтрокаТаблица.Товар.Артикул;  
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)
	Если Состояние = Перечисления.СтатусыАктаВозврата.Разнесено Тогда	
		Движения.РегистрНакопления1.Записывать = Истина;
		
		Для Каждого ТекСтрокаТаблица Из Таблица Цикл
			Движение = Движения.РегистрНакопления1.Добавить();
			Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
			Движение.Колво  	 = ТекСтрокаТаблица.Количество;
			Движение.машина 	 = ТекСтрокаТаблица.машина;
			Движение.индкод 	 = ТекСтрокаТаблица.партия;
			Движение.Товар 	  	 = ТекСтрокаТаблица.Товар;
			Движение.Склад  	 = Склад;
			Движение.Период 	 = Дата;					
		КонецЦикла;	
	КонецЕсли
	
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат
	КонецЕсли;
		
	///+ГомзМА 29.07.2024
	Сумма = ПолучитьСуммуПродажи(Продажа);
	СуммаВозвтрата = ПолучитьСуммуВозвратов(Продажа);
	Сумма = Сумма - СуммаВозвтрата;
			
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	БонусыСотрудниковОтПродажи.Сотрудник КАК Сотрудник,
	|	БонусыСотрудниковОтПродажи.Период КАК Период
	|ИЗ
	|	РегистрСведений.БонусыСотрудниковОтПродажи КАК БонусыСотрудниковОтПродажи
	|ГДЕ
	|	БонусыСотрудниковОтПродажи.Продажа = &Продажа";

	Запрос.УстановитьПараметр("Продажа", Продажа);

	РезультатЗапроса = Запрос.Выполнить().Выбрать();

	Пока РезультатЗапроса.Следующий() Цикл
		ЗаписьВРегистреСведений = РегистрыСведений.БонусыСотрудниковОтПродажи.СоздатьМенеджерЗаписи();
		ЗаписьВРегистреСведений.Период 		= РезультатЗапроса.Период;
		ЗаписьВРегистреСведений.Сотрудник 	= РезультатЗапроса.Сотрудник;
		ЗаписьВРегистреСведений.Прочитать();
		Если ЗаписьВРегистреСведений.Выбран() Тогда
			ЗаписьВРегистреСведений.Сумма = Сумма;
		КонецЕсли;
		ЗаписьВРегистреСведений.Записать();
	КонецЦикла;
		 
		
	//МассивКладовщиков = ПолучитьРольПользователя(Сделка.ЗаказКлиента);
		
	///-ГомзМА 29.07.2024
	
КонецПроцедуры

Функция ПолучитьСуммуПродажи(Продажа)
	
	///+ГомзМА 29.07.2024
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ПриходДенегНаСчет.Сделка.Ссылка КАК Продажа,
		|	СУММА(ПриходДенегНаСчет.СуммаДокумента) КАК СуммаПриходаДенег
		|ИЗ
		|	Документ.ПриходДенегНаСчет КАК ПриходДенегНаСчет
		|ГДЕ
		|	ПриходДенегНаСчет.Сделка = &Сделка
		|	И ПриходДенегНаСчет.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ПриходДенегНаСчет.Сделка.Ссылка";
	
	Запрос.УстановитьПараметр("Сделка", Продажа);
	
	РезультатЗапроса = Запрос.Выполнить().Выбрать();
	
	Попытка
		РезультатЗапроса.Следующий();
		СуммаПриходаДенег = РезультатЗапроса.СуммаПриходаДенег;
		СуммаПродажи = РезультатЗапроса.Продажа.ИтогоРекв;
		
		Если СуммаПриходаДенег > СуммаПродажи Тогда
			Результат = СуммаПродажи;
		Иначе
			Результат = СуммаПриходаДенег;
		КонецЕсли;
	Исключение
		Результат = 0;
	КонецПопытки;

	Возврат Результат;
	///-ГомзМА 29.07.2024
	
КонецФункции

Функция ПолучитьСуммуВозвратов(Продажа)
	
	///+ГомзМА 29.07.2024
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	СУММА(АктВозврата.ОбщаяСумма) КАК ОбщаяСумма
		|ИЗ
		|	Документ.АктВозврата КАК АктВозврата
		|ГДЕ
		|	АктВозврата.Продажа = &Продажа
		|	И АктВозврата.Проведен";
	
	Запрос.УстановитьПараметр("Продажа", Продажа);
	
	РезультатЗапроса = Запрос.Выполнить().Выбрать();
	
	Попытка
		РезультатЗапроса.Следующий();
		Результат = Число(РезультатЗапроса.ОбщаяСумма);
	Исключение
		Результат = 0;
	КонецПопытки;

	Возврат Результат;
	///-ГомзМА 29.07.2024
	
КонецФункции