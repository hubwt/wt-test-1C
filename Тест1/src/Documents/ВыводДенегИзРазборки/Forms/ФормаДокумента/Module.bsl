
&НаКлиенте
Процедура ИтогСумма(Команда)
	// Вставить содержимое обработчика.
	Объект.Сумма = 0;
	Для Каждого строка из Объект.Таблица Цикл
		Объект.Сумма = Объект.Сумма + строка.итогсум;
	КонецЦикла;
	Объект.Нам = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Нам = Объект.Нам + стр.нам;
	КонецЦикла;
	Объект.Марату = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Марату = Объект.Марату + стр.марату;
	КонецЦикла;
	Объект.Artem = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Artem = Объект.Artem + стр.Artem;
	КонецЦикла;
	Объект.МаратуНаличкой = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.МаратуНаличкой = Объект.МаратуНаличкой + стр.МаратуНаличкой;
	КонецЦикла;
	Объект.ИтогоОткатов = 0;
	Для Каждого стр из Объект.Таблица Цикл
		стр.Расходы = стр.Документ.Расход + стр.Документ.Откат+ПолучитьОбщРасх(стр.Документ);
		Объект.ИтогоОткатов = Объект.ИтогоОткатов + стр.Расходы;
		стр.Выведено = ПолучитьРасходы(стр.Документ);
	КонецЦикла;
    Для Каждого стр из Объект.Таблица Цикл
		стр.итогсум =  стр.Документ.ИтогоРекв - стр.Расходы - стр.Выведено;
	КонецЦикла;

КонецПроцедуры

&НаКлиенте
Процедура Печать(Команда)
	ТабДокумент = ПечатьСервер();
	ТабДокумент.Показать();

КонецПроцедуры

// <Описание функции>
//
// Параметры:
//  <Параметр1>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>
//  <Параметр2>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>
//
// Возвращаемое значение:
//   <Тип.Вид>   - <описание возвращаемого значения>
//
&НаСервере
Функция ПечатьСервер()
	
	ТабДокумент = Новый ТабличныйДокумент;
	ТабДокумент.АвтоМасштаб = Истина;
	Макет       =   ПолучитьМакет("Макет");
	ОбластьМакета = Макет.ПолучитьОбласть("шапка");
	ОбластьМакета.Параметры.заголовок = "Отчет о переданных деньгах № "+Объект.Номер + " от "+Формат(Объект.Дата,"ДФ=""дд.ММ.гггг""");
	ТабДокумент.Вывести(ОбластьМакета);
	строка =  Макет.ПолучитьОбласть("строка");
	Для Каждого элем из Объект.Таблица Цикл
		строка.Параметры.ндок = элем.Документ.Номер;
		строка.Параметры.наим = "Продажа запчастей № " + элем.Документ.Номер + " от "+ элем.Документ.Дата;
		строка.Параметры.сумма = элем.итогсум;
		строка.Параметры.нам = элем.нам;
		строка.Параметры.марату = элем.марату;
		строка.Параметры.артему = элем.Artem;
		строка.Параметры.сум = элем.Документ.ИтогоРекв;
		строка.Параметры.рас = элем.Расходы;
		ТабДокумент.Вывести(строка);
	КонецЦикла;
	ОбластьМакета = Макет.ПолучитьОбласть("подвал");
	ОбластьМакета.Параметры.итого = Объект.Сумма;
	ОбластьМакета.Параметры.инам = Объект.Нам;
	ОбластьМакета.Параметры.имарату = Объект.Марату;
	ОбластьМакета.Параметры.иартему = Объект.Artem;
	ОбластьМакета.Параметры.комментарий = Объект.Комментарий;
	ТабДокумент.Вывести(ОбластьМакета);

	
	Возврат ТабДокумент;

КонецФункции 


&НаСервере
Функция ПолучитьМакет(название)
	Возврат  Документы.ВыводДенегИзРазборки.ПолучитьМакет(название);
КонецФункции


&НаКлиенте
Процедура ТаблицанамПриИзменении(Элемент)
	Объект.Нам = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Нам = Объект.Нам + стр.нам;
	КонецЦикла;
	Объект.Марату = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Марату = Объект.Марату + стр.марату;
	КонецЦикла;
	Объект.Artem = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Artem = Объект.Artem + стр.Artem;
	КонецЦикла;
	Объект.ИтогоОткатов = 0;
	Для Каждого стр из Объект.Таблица Цикл
		стр.Расходы = стр.Документ.Расход + стр.Документ.Откат+ПолучитьОбщРасх(стр.Документ);
		Объект.ИтогоОткатов = Объект.ИтогоОткатов + стр.Расходы;
		стр.Выведено = ПолучитьРасходы(стр.Документ);
	КонецЦикла;
	Объект.МаратуНаличкой = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.МаратуНаличкой = Объект.МаратуНаличкой + стр.МаратуНаличкой;
	КонецЦикла;
    Для Каждого стр из Объект.Таблица Цикл
		стр.итогсум =  стр.Документ.ИтогоРекв - стр.Расходы- стр.Выведено;
	КонецЦикла;
КонецПроцедуры


&НаКлиенте
Процедура ТаблицамаратуПриИзменении(Элемент)
	// Вставить содержимое обработчика.
	Объект.Нам = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Нам = Объект.Нам + стр.нам;
	КонецЦикла;
	Объект.Марату = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Марату = Объект.Марату + стр.марату;
	КонецЦикла;
	Объект.Artem = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Artem = Объект.Artem + стр.Artem;
	КонецЦикла;
	Объект.ИтогоОткатов = 0;
	Для Каждого стр из Объект.Таблица Цикл
		стр.Расходы = стр.Документ.Расход + стр.Документ.Откат+ПолучитьОбщРасх(стр.Документ);
		Объект.ИтогоОткатов = Объект.ИтогоОткатов + стр.Расходы;
		стр.Выведено = ПолучитьРасходы(стр.Документ);
	КонецЦикла;
	Объект.МаратуНаличкой = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.МаратуНаличкой = Объект.МаратуНаличкой + стр.МаратуНаличкой;
	КонецЦикла;
    Для Каждого стр из Объект.Таблица Цикл
		стр.итогсум =  стр.Документ.ИтогоРекв - стр.Расходы- стр.Выведено;
	КонецЦикла;
КонецПроцедуры


&НаКлиенте
Процедура ТаблицаПриИзменении(Элемент)
	// Вставить содержимое обработчика.
	// Вставить содержимое обработчика.
	Объект.Нам = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Нам = Объект.Нам + стр.нам;
	КонецЦикла;
	Объект.Марату = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Марату = Объект.Марату + стр.марату;
	КонецЦикла;
	Объект.Artem = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Artem = Объект.Artem + стр.Artem;
	КонецЦикла;
	Объект.ИтогоОткатов = 0;
	Для Каждого стр из Объект.Таблица Цикл
		стр.Расходы = стр.Документ.Расход + стр.Документ.Откат+ПолучитьОбщРасх(стр.Документ);
		Объект.ИтогоОткатов = Объект.ИтогоОткатов + стр.Расходы;
		стр.Выведено = ПолучитьРасходы(стр.Документ);
	КонецЦикла;
	Объект.МаратуНаличкой = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.МаратуНаличкой = Объект.МаратуНаличкой + стр.МаратуНаличкой;
	КонецЦикла;
    Для Каждого стр из Объект.Таблица Цикл
		стр.итогсум =  стр.Документ.ИтогоРекв - стр.Расходы - стр.Выведено;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Функция ПолучитьОбщРасх(док)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	               |	СУММА(Расходы.Сумма) КАК Сумма
	               |ИЗ
	               |	Документ.Расходы КАК Расходы
	               |ГДЕ
	               |	Расходы.Откуда = &Откуда";
	Запрос.УстановитьПараметр("Откуда",док);
	Возврат Запрос.Выполнить().Выгрузить().Итог("Сумма");
КонецФункции

&НаСервере
Функция ПолучитьРасходы(ДокНо)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВыводДенегИзРазборки.Таблица.(
	               |		нам,
	               |		марату,
	               |		Документ,
	               |		Artem,
	               |		МаратуНаличкой
	               |	)
	               |ИЗ
	               |	Документ.ВыводДенегИзРазборки КАК ВыводДенегИзРазборки
	               |ГДЕ
	               |	ВыводДенегИзРазборки.Таблица.Документ = &ДокНо
	               |	И ВыводДенегИзРазборки.Проведен = ИСТИНА
	               |	И ВыводДенегИзРазборки.Ссылка <> &Ссыл";
	Запрос.УстановитьПараметр("ДокНо",ДокНо);
	Запрос.УстановитьПараметр("Ссыл",Объект.Ссылка);
	
	Табл = Запрос.Выполнить().Выгрузить();
	расх = 0;
	Для Каждого Строка Из Табл Цикл
		Для Каждого стр1 Из Строка.Таблица Цикл
			Если стр1.Документ = ДокНо Тогда
				расх = расх + стр1.нам+стр1.марату+стр1.Artem+стр1.МаратуНаличкой;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	Возврат расх;
КонецФункции


&НаКлиенте
Процедура ТаблицаДокументПриИзменении(Элемент)
	// Вставить содержимое обработчика.
	Объект.Нам = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Нам = Объект.Нам + стр.нам;
	КонецЦикла;
	Объект.Марату = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Марату = Объект.Марату + стр.марату;
	КонецЦикла;
	Объект.Artem = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.Artem = Объект.Artem + стр.Artem;
	КонецЦикла;
	Объект.ИтогоОткатов = 0;
	Для Каждого стр из Объект.Таблица Цикл
		стр.Расходы = стр.Документ.Расход + стр.Документ.Откат+ПолучитьОбщРасх(стр.Документ);
		Объект.ИтогоОткатов = Объект.ИтогоОткатов + стр.Расходы;
		стр.Выведено = ПолучитьРасходы(стр.Документ); 
	КонецЦикла;
	Объект.МаратуНаличкой = 0;
	Для Каждого стр из Объект.Таблица Цикл
		Объект.МаратуНаличкой = Объект.МаратуНаличкой + стр.МаратуНаличкой;
	КонецЦикла;
	Для Каждого стр из Объект.Таблица Цикл
		стр.итогсум =  стр.Документ.ИтогоРекв - стр.Расходы - стр.Выведено;
	КонецЦикла;
КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
КонецПроцедуры


&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Если Параметры.Ключ.Пустая() Тогда
		Объект.Кто = НайтиПользователя();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция НайтиПользователя()
	// ++ obrv 16.01.18
	//Возврат Справочники.Пользователи.НайтиПоНаименованию(ПолноеИмяПользователя());
	Возврат ПользователиКлиентСервер.ТекущийПользователь();
	// -- obrv 16.01.18
КонецФункции


